<style></style>

<section id="toolbar"></section>

<section type="template" id="template">
  <a-row>
    <a-col>
      <a-title key="2031559654080418" data-name="付款申请单"></a-title>
    </a-col>
  </a-row>
  <a-row>
    <a-col>
      <a-create-by key="creater" data-name="创建人"></a-create-by>
    </a-col>
    <a-col>
      <a-created-time key="createdTime" data-name="创建时间"></a-created-time>
    </a-col>
    <a-col>
      <a-sequence-no key="sequenceNo" data-name="单据号"></a-sequence-no>
    </a-col>
  </a-row>
  <a-row>
    <a-col>
      <a-group-title
        key="2001559654080418"
        data-name="业务标题"
      ></a-group-title>
    </a-col>
  </a-row>
  <a-row>
    <a-col>
      <a-text
        key="ccode"
        data-name="单据编号"
        data-visible="false"
        data-default-value=""
      ></a-text>
    </a-col>
  </a-row>
  <a-row>
    <a-col>
      <a-date
        key="ddate"
        data-name="单据日期"
        data-default-value="current"
      ></a-date>
    </a-col>
  </a-row>
  <a-row>
    <a-col>
      <a-radio
        key="ctpye"
        data-name="是否费用申请"
        data-name_i18n='{"en":"是否费用申请"}'
        data-on-change="this.cvencode.value="
        data-default-value="是"
        data-options="是;否"
      ></a-radio>
    </a-col>
    <a-col>
      <a-association-form
        key="purchaseOrder"
        data-name="选择采购订单"
        data-display-formula="{ctpye} == '否'"
        data-query-code="purchaseOrder"
        data-schema-code="purchaseOrder"
        data-mappings="cvencode:{cvencode};cvenname:{cvenname};cpersoncode:{cpersoncode};cdepcode:{cdepcode};cexch_name:{cexch_name};fexchrate:{fexchrate};sequenceNo:{ccode};ccode:{cpocode}"
      ></a-association-form>
    </a-col>
    <a-col>
      <a-text
        key="cpocode"
        data-name="采购订单号"
        data-display-formula="{ctpye} == '否'"
        data-default-value=""
      ></a-text>
    </a-col>
  </a-row>
  <a-row>
    <a-col>
      <a-text
        key="cvencode"
        data-name="供应商编码"
        data-default-value=""
      ></a-text>
    </a-col>
    <a-col>
      <a-text
        key="cvenname"
        data-name="供应商名称"
        data-default-value=""
      ></a-text>
    </a-col>
  </a-row>
  <a-row>
    <a-col>
      <a-association-form
        key="settlestyle"
        data-name="选择结算方式"
        data-query-code="settleStyle"
        data-schema-code="settleStyle"
        data-mappings="csscode:{cSSCode}"
        data-select-mode="dropdown"
      ></a-association-form>
    </a-col>
    <a-col>
      <a-association-form
        key="cexch"
        data-name="币种"
        data-display-formula="{ctpye} == '是'"
        data-query-code="currencyType"
        data-schema-code="currencyType"
        data-mappings="cexch_name:{cexch_name}"
      ></a-association-form>
    </a-col>
    <a-col>
      <a-number key="fexchrate" data-name="汇率"></a-number>
    </a-col>
  </a-row>
  <a-row>
    <a-col>
      <a-text
        key="cexch_name"
        data-name="币种"
        data-display-formula="{ctpye} == '否'"
        data-default-value=""
      ></a-text>
    </a-col>
  </a-row>
  <a-row>
    <a-col>
      <a-text
        key="cSSCode"
        data-name="结算方式"
        data-visible="false"
        data-default-value=""
      ></a-text>
    </a-col>
  </a-row>
  <a-row>
    <a-col>
      <a-user-selector
        key="cdepcode"
        data-name="部门"
        data-dept-visible="org"
        data-default-value=""
        data-org-root=""
      ></a-user-selector>
    </a-col>
    <a-col>
      <a-user-selector
        key="cpersoncode"
        data-name="业务员"
        data-dept-visible="user"
        data-org-root=""
      ></a-user-selector>
    </a-col>
  </a-row>
  <a-row>
    <a-col>
      <a-text key="bank" data-name="开户行"></a-text>
    </a-col>
    <a-col>
      <a-text key="bankaccount" data-name="银行账号"></a-text>
    </a-col>
  </a-row>
  <a-row>
    <a-col>
      <a-sheet
        key="payApplicationFormSon"
        data-name="付款申请单子表"
        data-rows="0"
      >
        <a-columns>
          <a-association-form
            key="material"
            width="200"
            data-name="物料"
            data-query-code="materialProfiles"
            data-schema-code="materialProfiles"
            data-mappings="cinvcode:{payApplicationFormSon.cinvcode};cinvname:{payApplicationFormSon.cinvname}"
          ></a-association-form>
          <a-text
            key="cinvcode"
            width="150"
            data-name="物料编码"
            data-display-formula="{ctpye} == '否'"
            data-default-value=""
          ></a-text>
          <a-text
            key="cinvname"
            width="150"
            data-name="物料名称"
            data-display-formula="{ctpye} == '否'"
            data-default-value=""
          ></a-text>
          <a-text
            key="cinvstd"
            width="150"
            data-name="规格"
            data-display-formula="{ctpye} == '否'"
            data-default-value=""
          ></a-text>
          <a-text
            key="cunitname"
            width="150"
            data-name="计量单位"
            data-display-formula="{ctpye} == '否'"
            data-default-value=""
          ></a-text>
          <a-number
            key="ftaxsum"
            width="150"
            data-name="本币金额"
            data-display-formula="{ctpye} == '否'"
            data-default-value=""
            data-format="percentile"
          ></a-number>
          <a-number
            key="fsum"
            width="150"
            data-name="原币金额"
            data-display-formula="{ctpye} == '否'"
            data-default-value=""
            data-format="percentile"
          ></a-number>
          <a-number
            key="amount"
            width="150"
            data-name="本次申请付款金额"
            data-format="percentile"
          ></a-number>
          <a-number
            key="alredyPaid"
            width="150"
            data-name="已申请付款金额"
            data-display-formula="{ctpye} == '否'"
            data-default-value="0"
            data-format="percentile"
          ></a-number>
          <a-association-form
            key="project"
            width="200"
            data-name="选择项目"
            data-display-formula="{ctpye} == '是'"
            data-query-code="projectsProfile"
            data-schema-code="projectsProfile"
            data-mappings="cprojectcode:{payApplicationFormSon.cprojectcode};cprojectname:{payApplicationFormSon.cprojectname}"
          ></a-association-form>
          <a-text
            key="cprojectcode"
            width="150"
            data-name="项目编码"
            data-default-value=""
          ></a-text>
          <a-text
            key="cprojectname"
            width="150"
            data-name="项目名称"
            data-default-value=""
          ></a-text>
          <a-date
            key="dPrePayDate"
            width="200"
            data-name="预计付款日期 "
          ></a-date>
          <a-text
            key="UUID"
            width="150"
            data-name="UUID"
            data-visible="false"
          ></a-text>
        </a-columns>
        <a-totals>
          <a-total
            key="stat-ftaxsum"
            column-key="ftaxsum"
            data-statistic-mode="sum"
            data-format="percentile"
            data-name="统计"
          ></a-total>
          <a-total
            key="stat-fsum"
            column-key="fsum"
            data-statistic-mode="sum"
            data-format="percentile"
            data-name="统计"
          ></a-total>
          <a-total
            key="stat-alredyPaid"
            column-key="alredyPaid"
            data-statistic-mode="sum"
            data-format="percentile"
            data-name="统计"
          ></a-total>
          <a-total
            key="stat-Number1563612831076"
            column-key="amount"
            data-statistic-mode="sum"
            data-format="percentile"
            data-name="统计"
          ></a-total>
        </a-totals>
      </a-sheet>
    </a-col>
  </a-row>
  <a-row>
    <a-col>
      <a-attachment
        key="attachment"
        data-name="附件"
        data-limit="10M"
      ></a-attachment>
    </a-col>
  </a-row>
</section>

<script id="customScript">
  (function(form) {
    /**
     * 用户自定义JS区域
     */
    /**
     * 事件绑定，form.on
     * @param eventType 事件类型
     * @params function 事件
     * @param  cover    true, false 是否覆盖root的生命周期 默认不覆盖
     */
    //数据加载后，渲染之前，this为window
    var shipment = [];
    form.on("onLoad", function(data, dataPermission) {}, "cover");
    //渲染完成后
    form.on("onRendered", function(data) {
      var self = this;
      this.purchaseOrder.valueChange.subscribe(changed => {
        for (let i = 0; i < this.payApplicationFormSon.value.length; i++) {
          this.payApplicationFormSon.removeRow(i);
        }
        if (changed.value == null) {
          return;
        }
        axios
          .get(
            window.config.apiHost +
              "/api/bmetech/getPayApplicationSubformInfo?purchaseOrderId=" +
              changed.value.id
          )
          .then(res => {
            if (res.errcode == 0) {
              let payApplicationArr = [];
              res.data.forEach((item, index) => {
                item.UUID =
                  item.uuid == "" ? item.project.id + "" + index : item.uuid;
                if (
                  item.amount != "" &&
                  item.amount != undefined &&
                  item.amount != 0
                ) {
                  payApplicationArr.push({
                    UUID: item.UUID,
                    alredyPaid: item.alredyPaid,
                    amount: item.amount,
                    cinvcode: item.cinvcode,
                    cinvname: item.cinvname,
                    cinvstd: item.cinvstd,
                    cprojectcode: item.cprojectcode,
                    cprojectname: item.cprojectname,
                    cunitname: item.cunitname,
                    dPrePayDate: item.dPrePayDate,
                    ftaxsum: item.ftaxsum,
                    fsum: Number(item.fsum),
                    id: item.id
                  });
                }
              });
              for (
                let i = 0;
                i < this.payApplicationFormSon.value.length;
                i++
              ) {
                this.payApplicationFormSon.removeRow(i);
              }
              if (payApplicationArr.length > 0) {
                // for(let i=0;i<this.payApplicationFormSon.value.length;i++){
                //     this.payApplicationFormSon.removeRow(i);
                // }
                this.payApplicationFormSon.value = payApplicationArr;
                shipment = payApplicationArr;
                self.payApplicationFormSon
                  .getColumnValueChange("amount")
                  .subscribe(changed => {
                    var newValue = changed.value;
                    var oldValue = []; //储存后台传过来的原始数据保持不变
                    payApplicationArr.forEach(function(item, index) {
                      oldValue.push(item.amount);
                    });
                    for (var i = 0; i < oldValue.length; i++) {
                      if (
                        newValue[i] <= oldValue[i] ||
                        newValue[i] == undefined
                      ) {
                        shipment = self.payApplicationFormSon.value;
                      } else {
                        shipment[i].amount = oldValue[i];
                        self.payApplicationFormSon.value = shipment;
                        self.$message.error("输入数字不能超过" + oldValue[i]);
                      }
                    }
                  });
              } else {
                this.payApplicationFormSon.value = [
                  {
                    UUID: "",
                    alredyPaid: undefined,
                    amount: undefined,
                    cinvcode: "",
                    cinvname: "",
                    cinvstd: "",
                    cprojectcode: "",
                    cprojectname: "",
                    cunitname: "",
                    dPrePayDate: null,
                    fsum: undefined,
                    ftaxsum: undefined,
                    id: undefined
                  }
                ];
              }
            }
          });
      });
      this.ctpye.valueChange.subscribe(changed => {
        let isDispaly = "";
        if (changed.value == "是") {
          isDispaly = "none";
        } else {
          isDispaly = "block";
        }
        let payApplicationFormSon = document.getElementById(
          "payApplicationFormSon"
        );
        let sheetItem = payApplicationFormSon.getElementsByClassName(
          "sheet__cols"
        );
        for (let i = 0; i < sheetItem.length; i++) {
          sheetItem[i]
            .getElementsByClassName("sheet__row")[0]
            .getElementsByClassName("sheet__col")[0].style.display = isDispaly;
          sheetItem[i]
            .getElementsByClassName("sheet__row")[0]
            .getElementsByClassName("sheet__col")[1].style.display = isDispaly;
          sheetItem[i]
            .getElementsByClassName("sheet__row")[0]
            .getElementsByClassName("sheet__col")[2].style.display = isDispaly;
          sheetItem[i]
            .getElementsByClassName("sheet__row")[0]
            .getElementsByClassName("sheet__col")[3].style.display = isDispaly;
          sheetItem[i]
            .getElementsByClassName("sheet__row")[0]
            .getElementsByClassName("sheet__col")[4].style.display = isDispaly;
          sheetItem[i]
            .getElementsByClassName("sheet__row")[0]
            .getElementsByClassName("sheet__col")[5].style.display = isDispaly;
          sheetItem[i]
            .getElementsByClassName("sheet__row")[0]
            .getElementsByClassName("sheet__col")[6].style.display = isDispaly;
          sheetItem[i]
            .getElementsByClassName("sheet__row")[0]
            .getElementsByClassName("sheet__col")[8].style.display = isDispaly;
        }
      });
    });
    //内置校验完成后，返回false阻止提交
    form.on("onValidate", function(action, data) {});
    //操作前（包含自定义按钮）执行，返回false阻止按钮操作
    form.on("onPreAction", function(action, data) {});
    //自定义按钮执行
    form.on("onCustomAction", function(action, data) {});
    //操作完成后执行
    form.on("onActionDone", function(action, data, httpRes) {});
  });
</script>
