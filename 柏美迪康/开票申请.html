<style>
</style>

<section id="toolbar"></section>

<section type="template" id="template">
<a-row>
    <a-col>
        <a-title key="2031559651217767" data-name="开票申请单"></a-title>
    </a-col>
</a-row>
<a-row>
    <a-col>
        <a-create-by key="creater" data-name="创建人"></a-create-by>
    </a-col>
    <a-col>
        <a-created-time key="createdTime" data-name="创建时间"></a-created-time>
    </a-col>
    <a-col>
        <a-sequence-no key="sequenceNo" data-name="单据号"></a-sequence-no>
    </a-col>
</a-row>
<a-row>
    <a-col>
        <a-group-title key="2001559651217767" data-name="业务标题"></a-group-title>
    </a-col>
</a-row>
<a-row>
    <a-col>
        <a-text key="ccode" data-name="单据号" data-visible="false" data-default-value=""></a-text>
    </a-col>
</a-row>
<a-row>
    <a-col>
        <a-date key="ddate" data-name="开票日期" data-default-value="current"></a-date>
    </a-col>
</a-row>
<a-row>
    <a-col>
        <a-association-form key="saleConfirm" data-name="选择销售确认单" data-query-code="saleConfirmForm" data-schema-code="saleConfirmForm" data-mappings="cstcode:{cstcode};ccuscode:{ccuscode};ccusname:{ccusname};cdepcode:{cdepcode};cpersoncode:{cpersoncode};cexch_name:{cexch_name};fexchrate:{fexchrate};cRegCode:{cRegCode};sequenceNo:{cdefine10}"></a-association-form>
    </a-col>
    <a-col>
        <a-text key="cstcode" data-name="销售类型" data-default-value=""></a-text>
    </a-col>
</a-row>
<a-row>
    <a-col>
        <a-text key="cdefine10" data-name="销售确认单号" data-default-value=""></a-text>
    </a-col>
</a-row>
<a-row>
    <a-col>
        <a-text key="ccuscode" data-name="客户编码" data-default-value=""></a-text>
    </a-col>
    <a-col>
        <a-text key="ccusname" data-name="客户名称" data-default-value=""></a-text>
    </a-col>
</a-row>
<a-row>
    <a-col>
        <a-text key="cexch_name" data-name="币种" data-default-value=""></a-text>
    </a-col>
    <a-col>
        <a-number key="fexchrate" data-name="汇率"></a-number>
    </a-col>
</a-row>
<a-row>
    <a-col>
        <a-user-selector key="cdepcode" data-name="销售部门" data-dept-visible="user" data-default-value="" data-org-root=""></a-user-selector>
    </a-col>
    <a-col>
        <a-user-selector key="cpersoncode" data-name="业务员" data-dept-visible="user" data-default-value="" data-org-root=""></a-user-selector>
    </a-col>
</a-row>
<a-row>
    <a-col>
        <a-radio key="invoiceType" data-name="发票类型" data-options="专票;普票"></a-radio>
    </a-col>
    <a-col>
        <a-dropdown key="VoucherType" data-name="发票类型" data-options="普票;专票;红字普票;红字专票"></a-dropdown>
    </a-col>
</a-row>
<a-row>
    <a-col>
        <a-association-form key="customer" data-name="选择客户税号" data-visible="false" data-query-code="customerProfile" data-schema-code="customerProfile" data-mappings="fregistfund:{cRegCode}"></a-association-form>
    </a-col>
    <a-col>
        <a-text key="cRegCode" data-name="社会信用统一代码" data-default-value=""></a-text>
    </a-col>
</a-row>
<a-row>
    <a-col>
        <a-sheet key="invoiceApplicationFormSon" data-name="开票申请单子表" data-rows="1">
            <a-columns>
                <a-text key="cwhcode" width="150" data-name="仓库编码" data-default-value=""></a-text>
                <a-text key="cwhname" width="150" data-name="仓库名称" data-default-value=""></a-text>
                <a-text key="cinvcode" width="150" data-name="物料编码" data-default-value=""></a-text>
                <a-text key="cinvname" width="150" data-name="物料名称" data-default-value=""></a-text>
                <a-text key="cinvstd" width="150" data-name="规格" data-default-value=""></a-text>
                <a-text key="cunitname" width="150" data-name="计量单位" data-default-value=""></a-text>
                <a-number key="iqty" width="150" data-name="本次开票数量" data-default-value="" data-format="percentile"></a-number>
                <a-number key="invoiceIssuedNum" width="150" data-name="已开票数量"></a-number>
                <a-number key="ctaxprice" width="150" data-name="含税单价" data-name_i18n='{"en":"含税单价"}' data-default-value="" data-format="percentile"></a-number>
                <a-number key="iprice" width="150" data-name="无税单价" data-default-value="" data-compute-formula="{invoiceApplicationFormSon.ctaxprice}/(1+{invoiceApplicationFormSon.itaxrate}/100)" data-format="percentile"></a-number>
                <a-number key="itaxrate" width="150" data-name="税率" data-format="ratio.percentile"></a-number>
                <a-number key="itax" width="150" data-name="税额" data-default-value="" data-compute-formula="{invoiceApplicationFormSon.isum}-{invoiceApplicationFormSon.imoney}" data-format="percentile"></a-number>
                <a-number key="imoney" width="150" data-name="无税金额" data-default-value="" data-compute-formula="{invoiceApplicationFormSon.iprice}*{invoiceApplicationFormSon.iqty}" data-format="percentile"></a-number>
                <a-number key="isum" width="150" data-name="价税合计" data-default-value="" data-compute-formula="{invoiceApplicationFormSon.ctaxprice}*{invoiceApplicationFormSon.iqty}" data-format="percentile"></a-number>
                <a-text key="cprojectcode" width="150" data-name="项目编码" data-default-value=""></a-text>
                <a-text key="cprojectname" width="150" data-name="项目名称" data-default-value=""></a-text>
                <a-text key="UUID" width="150" data-name="UUID" data-visible="false"></a-text>
            </a-columns>
            <a-totals>
                <a-total key="stat-iqty" column-key="iqty" data-statistic-mode="sum" data-format="integer" data-name="统计"></a-total>
                <a-total key="stat-itaxprice" column-key="itaxprice" data-statistic-mode="none" data-format="integer" data-name="统计"></a-total>
                <a-total key="stat-iprice" column-key="iprice" data-statistic-mode="none" data-format="integer" data-name="统计"></a-total>
                <a-total key="stat-itax" column-key="itax" data-statistic-mode="sum" data-format="percentile" data-name="统计"></a-total>
                <a-total key="stat-imoney" column-key="imoney" data-statistic-mode="sum" data-format="integer" data-name="统计"></a-total>
                <a-total key="stat-isum" column-key="isum" data-statistic-mode="sum" data-format="percentile" data-name="统计"></a-total>
                <a-total key="stat-Number1561950872944" column-key="itaxrate" data-statistic-mode="none" data-format="integer" data-name="统计"></a-total>
                <a-total key="stat-Number1562318016902" column-key="ctaxprice" data-statistic-mode="sum" data-format="integer" data-name="统计"></a-total>
                <a-total key="stat-Number1563449140067" column-key="invoiceIssuedNum" data-statistic-mode="sum" data-format="integer" data-name="统计"></a-total>
                <a-total key="stat-Number1563449314964" column-key="salesConfirmFormNum" data-statistic-mode="sum" data-format="integer" data-name="统计"></a-total>
                <a-total key="stat-Number1563505510972" column-key="notInvoicedNum" data-statistic-mode="sum" data-format="integer" data-name="统计"></a-total>
                <a-total key="stat-Number1563601844709" column-key="invoiceNum" data-statistic-mode="sum" data-format="integer" data-name="统计"></a-total>
            </a-totals>
        </a-sheet>
    </a-col>
</a-row>
</section>

<script id="customScript">
    (function(form){
        /**
         * 用户自定义JS区域
         */
        /**
         * 事件绑定，form.on
         * @param eventType 事件类型
         * @params function 事件
         * @param  cover    true, false 是否覆盖root的生命周期 默认不覆盖 
         */
        //数据加载后，渲染之前，this为window
        form.on('onLoad',function(data, dataPermission){},'cover');
        //渲染完成后
        form.on('onRendered',function(data){
            console.log(this.invoiceApplicationFormSon.value)
            //隐藏按钮
            // document.getElementsByClassName('actions')[0].style.display = 'none'
            var _this = this;
            _this.saleConfirm.valueChange.subscribe(changed => {
                // for(let i=0;i<_this.invoiceApplicationFormSon.value.length;i++){
                //     _this.invoiceApplicationFormSon.removeRow(i);
                // }
                
                axios.get("/api/bmetech/getInvoceApplicationSubformInfo?saleConfirmFormId=" + changed.value.id)
                .then(function(data) {
                    var dataArr = [];
                    data.data.forEach(function(item) {
                        var notInvoicedNum = Number(item.iqty) - Number(item.invoiceIssuedNum)
                        if(notInvoicedNum > 0) {
                            dataArr.push({
                                cwhcode: item.cwhcode,
                                cwhname: item.cwhname,
                                cinvcode: item.cinvcode,
                                cinvname: item.cinvname,
                                cinvstd: item.cinvstd,
                                cunitname: item.cunitname,
                                iqty: Number(item.iqty),
                                invoiceIssuedNum: Number(item.invoiceIssuedNum),
                                notInvoicedNum: Number(notInvoicedNum),
                                ctaxprice: Number(item.ctaxprice),
                                itaxrate: Number(item.itaxrate),
                                cprojectcode: item.cprojectcode,
                                cprojectname: item.cprojectname,
                                UUID: item.uuid,
                                id: item.id
                            })
                        }
                    });
                    for(let i=0;i<_this.invoiceApplicationFormSon.rows.length;i++){
                        _this.invoiceApplicationFormSon.removeRow(i);
                    }
                    
                    if(dataArr.length > 0){
                        _this.invoiceApplicationFormSon.value = dataArr
                    }else{
                        //  _this.invoiceApplicationFormSon.value = [{
                        //     UUID: "",cinvcode: "",cinvname: "",cinvstd: "",cprojectcode: "",
                        //     cprojectname: "",cunitname: "",cwhcode: "",cwhname: "",
                        //     id: undefined,imoney: undefined,invoiceIssuedNum: 0,
                        //     iprice: undefined,iqty: 0,isum: undefined,
                        //     itax: undefined,itaxprice: undefined,itaxrate: undefined,
                        //     notInvoicedNum: undefined,}]
                        for(var i =0;i<_this.invoiceApplicationFormSon.rows.length;i++){
                            _this.invoiceApplicationFormSon.removeRow(i)
                        }
                    }
                })
            })
        });
        //内置校验完成后，返回false阻止提交
        form.on('onValidate',function(action,data){});
        //操作前（包含自定义按钮）执行，返回false阻止按钮操作
        form.on('onPreAction',function(action,data){});
        //自定义按钮执行
        form.on('onCustomAction',function(action,data){});
        //操作完成后执行
        form.on('onActionDone',function(action,data,httpRes){});
    })
</script>